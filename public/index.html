<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aspects — Practical Astrology</title>
  <meta name="description" content="Aspects: practical self-awareness for people who don’t believe in astrology." />
  <style>
    :root{
      --bg:#0b0d12; --card:#121726; --text:#e9ecf5; --muted:#a9b1c7;
      --line:#222a42; --accent:#7aa2ff; --ok:#58d68d; --warn:#ffd166;
      --bad:#ff5c7a;
      --r:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background:linear-gradient(180deg, #070913 0%, #0b0d12 60%, #06070c 100%);
      color:var(--text);
    }
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:1040px; margin:0 auto; padding:24px}
    header{display:flex; align-items:center; justify-content:space-between; gap:16px; padding:14px 0 18px}
    .brand{display:flex; flex-direction:column; gap:4px}
    .brand h1{margin:0; font-size:20px; letter-spacing:.3px}
    .brand p{margin:0; color:var(--muted); font-size:13px}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border:1px solid var(--line); border-radius:999px;
      background:rgba(18,23,38,.7);
      color:var(--muted); font-size:13px;
    }
    .grid{display:grid; grid-template-columns: 360px 1fr; gap:16px}
    @media (max-width: 920px){ .grid{grid-template-columns:1fr} }
    .card{
      background:rgba(18,23,38,.9);
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .card h2{margin:0 0 10px; font-size:16px}
    .card h3{margin:16px 0 8px; font-size:14px; color:var(--muted); font-weight:600}
    .row{display:grid; grid-template-columns:1fr; gap:10px}
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px}
    input, select, button, textarea{
      width:100%;
      padding:11px 12px;
      border:1px solid var(--line);
      border-radius:12px;
      background:#0c1020;
      color:var(--text);
      outline:none;
    }
    input::placeholder{color:#6e7895}
    input:focus, select:focus, textarea:focus{border-color:rgba(122,162,255,.7); box-shadow:0 0 0 3px rgba(122,162,255,.15)}
    .two{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .actions{display:flex; gap:10px; margin-top:10px}
    .actions button{cursor:pointer; font-weight:700}
    .primary{background:linear-gradient(180deg, rgba(122,162,255,.95), rgba(122,162,255,.7)); border-color:rgba(122,162,255,.6); color:#071021}
    .ghost{background:transparent}
    .small{font-size:12px; color:var(--muted)}
    .hr{height:1px; background:var(--line); margin:14px 0}
    .kpi{display:flex; gap:10px; flex-wrap:wrap}
    .kpi .chip{
      border:1px solid var(--line);
      background:rgba(12,16,32,.6);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
    }
    .status{font-size:13px; color:var(--muted); margin-top:10px}
    .status.ok{color:var(--ok)}
    .status.bad{color:var(--bad)}
    .table{width:100%; border-collapse:collapse; margin-top:10px; overflow:hidden; border-radius:12px; border:1px solid var(--line)}
    .table th,.table td{padding:10px 10px; border-bottom:1px solid var(--line); text-align:left; font-size:13px}
    .table th{color:var(--muted); font-weight:700; background:rgba(12,16,32,.7)}
    .table tr:last-child td{border-bottom:none}
    .badge{
      display:inline-flex; align-items:center; padding:3px 8px; border-radius:999px;
      border:1px solid var(--line); background:rgba(12,16,32,.6); color:var(--muted); font-size:12px
    }
    .badge.tight{border-color:rgba(255,209,102,.35); color:var(--warn)}
    .badge.easy{border-color:rgba(88,214,141,.35); color:var(--ok)}
    .badge.hard{border-color:rgba(255,92,122,.35); color:var(--bad)}
    footer{margin-top:18px; color:var(--muted); font-size:12px}
    code.inline{padding:2px 6px; border:1px solid var(--line); border-radius:8px; background:rgba(12,16,32,.7)}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1>Aspects</h1>
        <p>Astrology for people who don’t believe in astrology — practical, not fortune-telling.</p>
      </div>
      <div class="pill" id="apiPill">
        <span>API:</span>
        <span id="apiUrlText">not set</span>
      </div>
    </header>

    <main class="grid">
      <!-- LEFT: INPUTS -->
      <section class="card">
        <h2>Birth details</h2>

        <div class="row">
          <div class="two">
            <div>
              <label for="birthDate">Birth date</label>
              <input id="birthDate" type="date" />
            </div>
            <div>
              <label for="birthTime">Birth time</label>
              <input id="birthTime" type="time" step="60" placeholder="HH:MM" />
              <div class="small">If unknown, pick a best-guess — we’ll mark confidence lower.</div>
            </div>
          </div>

          <div class="two">
            <div>
              <label for="city">Birth city</label>
              <input id="city" type="text" placeholder="e.g., Lancaster" />
            </div>
            <div>
              <label for="region">State/Region</label>
              <input id="region" type="text" placeholder="e.g., CA" />
            </div>
          </div>

          <div>
            <label for="country">Country</label>
            <input id="country" type="text" value="US" />
          </div>

          <div class="hr"></div>

          <h3>Backend</h3>
          <div>
            <label for="apiUrl">API base URL</label>
            <input id="apiUrl" type="url" value="https://aspects-backend.onrender.com" />
            <div class="small">This should match your deployed backend.</div>
          </div>

          <div class="actions">
            <button class="primary" id="btnCompute" type="button">Compute</button>
            <button class="ghost" id="btnDemo" type="button">Demo Data</button>
            <button class="ghost" id="btnReset" type="button">Reset</button>
          </div>

          <div id="status" class="status">Ready.</div>

          <div class="hr"></div>

          <h3>What you’ll get</h3>
          <div class="kpi">
            <div class="chip">Top aspects + plain-English meaning</div>
            <div class="chip">“Practical prompts” (behavior & patterns)</div>
            <div class="chip">Confidence markers (time unknown, etc.)</div>
          </div>
        </div>
      </section>

      <!-- RIGHT: OUTPUTS -->
      <section class="card">
        <h2>Results</h2>

        <div id="summary">
          <div class="small">Fill out birth details and hit <b>Compute</b>.</div>
        </div>

        <div class="hr"></div>

        <h3>Top aspects</h3>
        <table class="table" id="aspectsTable" aria-label="Aspects table">
          <thead>
            <tr>
              <th>Aspect</th>
              <th>Orb</th>
              <th>Intensity</th>
              <th>Plain English</th>
            </tr>
          </thead>
          <tbody id="aspectsTbody">
            <tr>
              <td colspan="4" class="small">No results yet.</td>
            </tr>
          </tbody>
        </table>

        <div class="hr"></div>

        <h3>Practical prompts</h3>
        <div id="prompts" class="small">
          Prompts will appear here.
        </div>

        <footer>
          Tip: If your backend endpoint differs, update it in the “API base URL” field.
          You can also hardcode it in this file near <code class="inline">DEFAULT_API_BASE</code>.
        </footer>
      </section>
    </main>
  </div>

  <script>
    // ====== Config ======
    const DEFAULT_API_BASE = "https://aspects-backend.onrender.com";
    // Expectation: your backend exposes something like:
    // POST {API_BASE}/api/chart
    // body: { date:"YYYY-MM-DD", time:"HH:MM", location:{city, region, country} }
    //
    // If your backend uses different routes/shape, change compute() accordingly.

    // ====== Elements ======
    const el = (id) => document.getElementById(id);
    const birthDate = el("birthDate");
    const birthTime = el("birthTime");
    const city = el("city");
    const region = el("region");
    const country = el("country");
    const apiUrl = el("apiUrl");
    const apiUrlText = el("apiUrlText");
    const apiPill = el("apiPill");
    const status = el("status");
    const summary = el("summary");
    const aspectsTbody = el("aspectsTbody");
    const prompts = el("prompts");

    // ====== Helpers ======
    function setStatus(msg, kind = "") {
      status.textContent = msg;
      status.className = "status " + (kind || "");
    }

    function badge(text, type) {
      return `<span class="badge ${type || ""}">${escapeHtml(text)}</span>`;
    }

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function clearResults() {
      summary.innerHTML = `<div class="small">No results yet.</div>`;
      aspectsTbody.innerHTML = `<tr><td colspan="4" class="small">No results yet.</td></tr>`;
      prompts.innerHTML = `<div class="small">Prompts will appear here.</div>`;
    }

    function getApiBase() {
      const v = (apiUrl.value || "").trim();
      return v || DEFAULT_API_BASE;
    }

    function setApiPill() {
      const base = getApiBase();
      apiUrlText.textContent = base.replace(/^https?:\/\//, "");
      apiPill.title = base;
    }

    // ====== Rendering ======
    function render(results) {
      // Expected example shape:
      // {
      //   meta: { timezone:"America/New_York", confidence:"high|medium|low", note:"..." },
      //   subject: { date, time, locationText },
      //   aspects: [{ a:"Sun", aspect:"Square", b:"Moon", orb:2.1, intensity:"hard", meaning:"...", prompt:"..." }, ...]
      // }
      const meta = results?.meta || {};
      const subj = results?.subject || {};
      const list = Array.isArray(results?.aspects) ? results.aspects : [];

      const conf = meta.confidence || "medium";
      const confBadge =
        conf === "high" ? badge("High confidence", "easy") :
        conf === "low"  ? badge("Low confidence", "hard") :
                          badge("Medium confidence", "tight");

      summary.innerHTML = `
        <div class="kpi">
          <div class="chip"><b>Subject:</b> ${escapeHtml(subj.locationText || "")}</div>
          <div class="chip"><b>DOB:</b> ${escapeHtml(subj.date || "")} ${escapeHtml(subj.time ? ("@" + subj.time) : "")}</div>
          <div class="chip">${confBadge}</div>
        </div>
        ${meta.note ? `<div class="small" style="margin-top:10px">${escapeHtml(meta.note)}</div>` : ""}
      `;

      if (!list.length) {
        aspectsTbody.innerHTML = `<tr><td colspan="4" class="small">No aspects returned.</td></tr>`;
        prompts.innerHTML = `<div class="small">No prompts.</div>`;
        return;
      }

      aspectsTbody.innerHTML = list.map(item => {
        const aspectText = `${item.a} ${item.aspect} ${item.b}`;
        const orb = (typeof item.orb === "number") ? `${item.orb.toFixed(2)}°` : (item.orb ?? "");
        const intensity = item.intensity || "tight";
        const intensityBadge =
          intensity === "easy" ? badge("easy", "easy") :
          intensity === "hard" ? badge("hard", "hard") :
                                 badge("tight", "tight");

        return `
          <tr>
            <td>${escapeHtml(aspectText)}</td>
            <td>${escapeHtml(orb)}</td>
            <td>${intensityBadge}</td>
            <td>${escapeHtml(item.meaning || "")}</td>
          </tr>
        `;
      }).join("");

      const promptItems = list
        .map(x => x.prompt)
        .filter(Boolean)
        .slice(0, 8);

      prompts.innerHTML = promptItems.length
        ? `<ol class="small" style="margin:0; padding-left:18px">${promptItems.map(p => `<li style="margin:8px 0">${escapeHtml(p)}</li>`).join("")}</ol>`
        : `<div class="small">No prompts returned.</div>`;
    }

    // ====== Networking ======
    async function compute() {
      setApiPill();
      setStatus("Computing…", "");
      clearResults();

      const base = getApiBase();
      const payload = {
        date: birthDate.value || null,
        time: birthTime.value || null,
        location: {
          city: (city.value || "").trim(),
          region: (region.value || "").trim(),
          country: (country.value || "").trim()
        }
      };

      // Quick minimal validation (front-end)
      if (!payload.date || !payload.location.city) {
        setStatus("Need at least: Birth date + Birth city.", "bad");
        return;
      }

      try {
        const res = await fetch(`${base.replace(/\/$/, "")}/api/chart`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const text = await res.text();
          setStatus(`API error (${res.status}). Check backend route /api/chart.`, "bad");
          summary.innerHTML = `<div class="small"><b>Backend said:</b> ${escapeHtml(text).slice(0, 700)}</div>`;
          return;
        }

        const data = await res.json();
        render(data);
        setStatus("Done.", "ok");
      } catch (err) {
        setStatus("Network error. Is the backend URL correct and live?", "bad");
        summary.innerHTML = `<div class="small">${escapeHtml(err?.message || String(err))}</div>`;
      }
    }

    // ====== Buttons ======
    el("btnCompute").addEventListener("click", compute);

    el("btnReset").addEventListener("click", () => {
      birthDate.value = "";
      birthTime.value = "";
      city.value = "";
      region.value = "";
      country.value = "US";
      apiUrl.value = DEFAULT_API_BASE;
      setApiPill();
      setStatus("Reset.", "");
      clearResults();
    });

    el("btnDemo").addEventListener("click", () => {
      // Demo defaults — change as you want
      birthDate.value = "1990-01-01";
      birthTime.value = "12:00";
      city.value = "Lancaster";
      region.value = "CA";
      country.value = "US";
      apiUrl.value = DEFAULT_API_BASE;
      setApiPill();
      setStatus("Demo data filled. Hit Compute.", "");
    });

    // ====== Init ======
    setApiPill();
    clearResults();
  </script>
</body>
</html>