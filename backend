{
  "name": "aspects-backend",
  "version": "1.0.0",
  "type": "module",
  "private": true,
  "scripts": {
    "start": "node server.js"
  },
  "dependencies": {
    "cors": "^2.8.5",
    "express": "^4.19.2",
    "swisseph": "^0.5.18"
  }
}
import express from "express";
import cors from "cors";
import swe from "swisseph";

const app = express();
app.use(cors());
app.use(express.json());

function toUtcDate(dateStr, timeStr, tzOffsetMinutes = 0) {
  if (!dateStr) throw new Error("Missing date");
  const [Y, M, D] = String(dateStr).split("-").map(Number);
  if (!Y || !M || !D) throw new Error("Invalid date. Use YYYY-MM-DD");

  const t = (timeStr && String(timeStr).includes(":")) ? String(timeStr) : "12:00";
  const [hh, mm] = t.split(":").map(Number);
  if (Number.isNaN(hh) || Number.isNaN(mm)) throw new Error("Invalid time. Use HH:MM");

  const utcMs = Date.UTC(Y, M - 1, D, hh, mm, 0) - (tzOffsetMinutes * 60 * 1000);
  return new Date(utcMs);
}

function julianDayFromUtcDate(dt) {
  const Y = dt.getUTCFullYear();
  const M = dt.getUTCMonth() + 1;
  const D = dt.getUTCDate();
  const hour = dt.getUTCHours() + dt.getUTCMinutes() / 60 + dt.getUTCSeconds() / 3600;
  return swe.julday(Y, M, D, hour, swe.GREG_CAL);
}

function norm360(x) {
  let v = x % 360;
  if (v < 0) v += 360;
  return v;
}

app.get("/health", (_req, res) => res.json({ ok: true }));

app.get("/api/planets", (req, res) => {
  try {
    const { date, time, tzOffsetMinutes } = req.query;
    const tzOff = tzOffsetMinutes === undefined ? 0 : Number(tzOffsetMinutes);
    if (Number.isNaN(tzOff)) throw new Error("tzOffsetMinutes must be a number (e.g., -300).");

    const utcDate = toUtcDate(date, time, tzOff);
    const jdUt = julianDayFromUtcDate(utcDate);

    // Swiss Ephemeris via swisseph; MOSEPH avoids ephemeris data files
    const flags = swe.SEFLG_MOSEPH;

    const bodies = [
      ["Sun", swe.SE_SUN],
      ["Moon", swe.SE_MOON],
      ["Mercury", swe.SE_MERCURY],
      ["Venus", swe.SE_VENUS],
      ["Mars", swe.SE_MARS],
      ["Jupiter", swe.SE_JUPITER],
      ["Saturn", swe.SE_SATURN],
      ["Uranus", swe.SE_URANUS],
      ["Neptune", swe.SE_NEPTUNE],
      ["Pluto", swe.SE_PLUTO],
    ];

    const planets = {};
    for (const [name, id] of bodies) {
      const r = swe.calc_ut(jdUt, id, flags);
      if (r.error) throw new Error(r.error);
      planets[name] = norm360(r.data[0]); // longitude
    }

    res.json({
      ok: true,
      input: { date, time: time || "12:00", tzOffsetMinutes: tzOff },
      utc: utcDate.toISOString(),
      jdUt,
      planets
    });
  } catch (err) {
    res.status(400).json({ ok: false, error: String(err.message || err) });
  }
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log(`Aspects backend listening on ${PORT}`));